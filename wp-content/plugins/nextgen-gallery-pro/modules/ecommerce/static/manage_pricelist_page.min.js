jQuery((function(t){t(".button-primary").on("click",(function(e){var i=!0,a=t("#title");return 0==a.val().trim().length?(e.preventDefault(),a.addClass("title_empty"),t(window).scrollTop(0),i=!1):a.removeClass("title_empty"),i})),t("#ngg_page_content form#ngg_pricelist_form input[type=submit], #ngg_page_content form#ngg_pricelist_form button[type=submit]").on("click",(function(){t("input[type=submit], button[type=submit]",t(this).parents("form")).removeAttr("clicked"),t(this).attr("clicked","true")})),t("#ngg_page_content form#ngg_pricelist_form").on("submit",(function(e){e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault();var i=t(this),a=i.find("[type=submit]"),n=a.filter("[clicked=true]");a.prop("disabled",!0),n.data("originalText")||n.data("originalText",n.html()),n.html(n.data("executing"));var r=i.serializeArray().filter((function(t,e,i){return!t.name.match(/^pricelist_item/i)})),o=t('#ngg_page_content form input[name^="pricelist_item"]').serializeJSON();return void 0!==o.pricelist_item&&r.push({name:"pricelist_item",value:JSON.stringify(o.pricelist_item)}),r.push({name:"action",value:"save_pricelist"}),t.post(photocrati_ajax.url,r,(function(t,e,a){n.html(n.data("originalText")),"object"!=typeof t&&(t=JSON.parse(t)),-1===i.attr("action").indexOf("ngg_wizard")&&window.setTimeout((function(){t.error?(alert(t.error),window.location=window.location):window.location=t.redirect_url}),300)})),!1})),t("#title").on("keypress",(function(){var e=t(this);0==e.val().trim().length?e.addClass("title_empty"):e.removeClass("title_empty")})),t("#ngg_pricelist_form").on("change",".price_field",(function(){var e=t(this),i=e.val().split("."),a=[i[0]];i.length>1&&a.push(i[1]);var n=a.join(".");(n=n.replace(/[^0-9\.]/g,"")).length>0&&"."!=n&&(n=sprintf("%.2f",parseFloat(n))),e.val(n)})).trigger("change"),t("#cancel_btn").on("click",(function(e){return e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),window.location=t(this).attr("data-redirect"),!1})),t("#ngg_pricelist_form").on("click",".delete_item",(function(){var e=t(this).attr("data-id"),i=t(this).attr("data-table-id"),a=t("#"+i).parent(),n=a.find(".no_items");a.find(".item_"+e).fadeOut(400,(function(){if(t(this).remove(),-1==e.indexOf("new")){var i=t("<input/>").attr({name:"deleted_items[]",type:"hidden",value:e});t("#ngg_page_content form").prepend(i)}0==a.find(".item").length&&n.fadeIn()}))})),t("#new_product_button_cancel, #bulk_markup_button_cancel").on("click",(function(t){t.stopPropagation(),t.stopImmediatePropagation(),t.preventDefault(),tb_remove()}));var e=function(t){var e=!1;return ngg_pro_pricelist_sources.hasOwnProperty(t)&&(e=ngg_pro_pricelist_sources[t]),e},i=function(){var e=t(window).height(),i=t(window).width(),a=TB_HEIGHT,n=TB_WIDTH;e<a&&(a=e-25,t("#TB_ajaxContent").outerHeight(a-90)),i<n&&(n=i-40,t("#TB_ajaxContent").outerWidth(n)),t("#TB_window").css({height:a,width:n,"margin-left":-n/2,"margin-top":-a/2});var r=t("#new_product_source_form").find(".catalog-dialog");if("yes"!=r.data("loaded")){var o=r.find(".catalog-categories"),d=r.find(".catalog-panel-container"),l=r.parents("#TB_ajaxContent").height();l-=o.outerHeight(!0),l-=71,l-=d.outerHeight(!0)-d.outerHeight(),d.outerHeight(l)}};t(window).on("resize",(function(){i()}));var a=function(e,a,n,r){void 0===n&&(n=t("#TB_window")),TB_HEIGHT=a,TB_WIDTH=e;var o=n.find("#TB_title"),d=-e/2,l=-(160+(a-383)/2);n.outerWidth(e),n.css({"margin-left":d,"margin-top":l}),n.find("#TB_ajaxContent").outerWidth(e).outerHeight(a-o.outerHeight(!0)),r&&i()},n=function(e){var i=!0;_(jQuery("#new_product_source_form :input")).each((function(t){t.checkValidity()||(i=!1)})),i?(t("#new_product_button_add").show(),void 0!==e&&13===e.keyCode&&t("#new_product_button_add").trigger("click")):t("#new_product_button_add").hide()};t("#new_product_source_list li.product-source-item").on("click",(function(){var i=t(this);_.each(t(".new_pricelist_item_wrapper"),(function(r){t(r).data("sourceId")==i.data("sourceId")&&(t("#new_product_source_list").hide(),t("#new_product_source_form").html(t(r).html()),t("#new_product_source_form").show(),n(),e(i.data("sourceId"))?(a(1e3,600,void 0,!0),function(i){var a=i.find(".catalog-dialog");if("yes"!=a.data("loaded")){var n=a.find(".catalog-categories"),r=n.find("li"),o=a.find(".catalog-panel-container"),d=o.find(".catalog-panel"),l=a.parents("#TB_ajaxContent").height();l-=n.outerHeight(!0),l-=71,l-=o.outerHeight(!0)-o.outerHeight(),d.hide(),d.first().show(),r.removeClass("selected"),r.first().addClass("selected"),o.outerHeight(l),a.find(".catalog-tabs-container li").on("click",(function(e){var i=t(this);r.removeClass("selected"),i.addClass("selected"),d.hide(),d.filter(i.find("a").attr("href")).show()})),a.find(".items-table tr.item-content").on("click",(function(e){var i=t(this).find(".item-added input.item-check");i.prop("checked",!i.is(":checked")),i.is(":checked")?i.attr("checked","checked"):i.prop("checked",!1)})),a.find(".items-table th.item-added label.check-all").on("click",(function(e){var i=t(this),a=i.parents("table.items-table"),n=i.siblings(".item-check");n.prop("checked",!n.is(":checked")),n.attr("checked",n.is(":checked")?"checked":null),a.find("td.item-added input.item-check").prop("checked",n.prop("checked"))})),a.find(".button.cancel").on("click",(function(t){a.hide()})),a.data("loaded","yes")}for(var c=t(".pricelist_category_collection").find("tr"),u=0,s=a.find("table.items-table tr.item-group"),p=0;p<c.length;p++){var _=t(c.get(p)),m=_.find(':input[name$="[source]"]');if(e(m.val())){u++;for(var f=_.find(':input[name*="[source_data]"]'),g=0;g<s.length;g++){(T=t(s.get(g))).data("itemPrefix");for(var h=!0,v=0;v<f.length;v++){var b=t(f.get(v)),k=b.attr("name"),w=b.val(),y=k.indexOf("[source_data]"),x=k.substr(y);if(T.find(':input[name$="'+x+'"]').val()!=w){h=!1;break}}h&&(T.find(':input[name$="[added]"]').prop("checked",!0),s.splice(g,1),g--)}}}if(u>0)for(g=0;g<s.length;g++){var T;(T=t(s.get(g))).find(':input[name$="[added]"]').prop("checked",!1)}}(t("#new_product_source_form"))):a(630,383,void 0,!1),t("#TB_ajaxWindowTitle").html(i.data("sourceTitle")),t("#new_product_source_form form").data("sourceId",i.data("sourceId")))}))})),t("body").on("change paste keyup","#new_product_source_form :input",n),t("body").on("thickbox:removed",(function(){t("#new_product_source_form").hide(),t("#new_product_button_add").hide(),t("#new_product_source_list").show(),t("#new_product_source_form form").data("sourceId","")}));for(var r=function(t,e,i){var a=parseFloat(t.find(':input[name$="[cost]"]').val())*(1+e/100);"none"!=i&&(a=Math.ceil(a),"cent"==i&&(a-=.01)),a=a.toFixed(2),t.find(':input[name$="[price]"]').val(a)},o=0,d=0,l={},c=t('script[type="ngg-template"]'),u=0;u<c.length;u++){var s=t(c.get(u)),p=s.data("sourceId"),m=s.data("categoryId");void 0!==p&&null!=p||(p="__default__"),m in l||(l[m]={},l[m].__default__=[]),p in l[m]||(l[m][p]=[]);var f={table_id:s.data("tableId"),template:t(s.html())};l[m][p].push(f)}var g=function(i,a,n){var c=null,u={},s=!0,p="",m=null;if(e(i)){for(var f=[],g=0;g<n.length;g++){var h=n[g],v="[source_data]",b=h.name.indexOf(v);b>-1&&f.push({name:h.name.substr(b+v.length),value:h.value})}c=function(e,i,a){void 0!==i&&i||(i=[]);for(var n=null,r=null,o=0;o<i.length;o++){var d=i[o];if("[catalog_id]"==d.name?n=d.value:"[product_id]"==d.name&&(r=d.value),null!=n&&null!=r)break}if(void 0!==a&&(a.catalog_id=n,a.product_id=r),null!=n&&null!=r){var l='.pricelist_category_item[data-catalog-id="'+n+'"][data-product-id="'+r+'"]',c=t(".pricelist_category_collection").children(l);if(c.length>0)return t(c.get(0))}return null}(0,f,u)}if(null!=c&&(s=!1,p=c.attr("id"),m=c.parents("tbody").first()),s){var k=null;if(void 0!==l[a][i]?k=l[a][i][0]:void 0!==l[a]&&(k=l[a].__default__[0]),null==k)return null;var w=k.table_id;m=t("#"+w),p="new-"+Math.random().toString(10).substr(2),(c=k.template.clone()).attr("id",c.attr("id").replace(/\{id\}/g,p)),c.attr("class",c.attr("class").replace(/\{id\}/g,p)),c.attr("data-catalog-id",u.catalog_id),c.attr("data-product-id",u.product_id)}c.find('[name="pricelist_item[{id}][source]"]').val(i),c.find('[name="pricelist_item[{id}][category]"]').val(a);var y=0,x=null,T=null;for(g=0;g<n.length;g++){var I=n[g],H=c.find('[name="'+I.name+'"]');if(s&&0==H.length&&I.name.indexOf("[source_data]")>-1&&(H=t('<input type="hidden" class="pricelist_item_hidden_source_data" />').attr("name",I.name),c.find("td").first().append(H)),H.length>0){var C=I.name.indexOf("[cost]");C>-1&&C+"[cost]".length==I.name.length&&(x=H);var B=I.name.indexOf("[price]");B>-1&&B+"[price]".length==I.name.length&&(T=H,H.attr("min",y)),""==I.value&&void 0!==H.data("defaultValue")&&(I.value=H.data("defaultValue")),H.val(I.value),H.attr("name",H.attr("name").replace(/\{id\}/g,p))}}(x&&(x.val(T.val()),T.val(T.val()),y=T.val()),0==y)?c.find('[name="pricelist_item[{id}][cost]"]').replaceWith('<div style="text-align: center;">-</div>'):(0==o&&(o=parseFloat(t(':input[name="pricelist[settings][bulk_markup_amount]"]').val())),0==d&&(d=t(':input[name="pricelist[settings][bulk_markup_rounding]"]').val()),r(c,o,d));return!!s&&(_.each(c.find("input[type=hidden]"),(function(e){var i=t(e),a=i.attr("name");"pricelist_item[{id}][sortorder]"==a&&i.val(m.find("tr.item").length),i.attr("name",a.replace(/\{id\}/g,p))})),_.each(c.find("i.delete_item"),(function(e){var i=t(e).data("id").replace(/\{id\}/g,p);e.setAttribute("data-id",i)})),{element:c,table:m})};t("#new_product_button_add").on("click",(function(){var e=!1,i=t("#new_product_source_form form"),a=i.data("sourceId"),n=i.serializeArray(),r=i.find(".item-group");0==r.length&&(r=i),_.each(r,(function(i){var r=t(i),o=r.data("itemPrefix"),d=r.find(":input"),l=d.filter(".item-check[type=checkbox]");if(0==l.length||l.is(":checked")){var c=t(_(d).filter((function(e){return"category"==t(e).data("fieldName")}))).val(),u=n;if(o&&""!=o){u=[];for(var s=0;s<n.length;s++){var p=n[s];0===p.name.indexOf(o)&&u.push({name:p.name.replace(o,""),value:p.value})}}var m=g(a,c,u);!1!==m&&(m.table.parent().find(".no_items").hide(),m.table.append(m.element),"ngg_category_canvas"==c&&(e=!0))}})),e&&setTimeout((function(){alert(manage_pricelist_page_i18n.gallery_wrap_notice)}),250),tb_remove()})),t("#bulk_markup_dialog form").on("submit",(function(i){i.stopPropagation(),i.stopImmediatePropagation(),i.preventDefault();for(var a=t(this).serializeArray(),n=0,o="none",d=0;d<a.length;d++){var l=a[d];"markup_percent"==l.name?n=parseInt(l.value):"markup_rounding"==l.name&&(o=l.value)}if(n>0){t(':input[name="pricelist[settings][bulk_markup_amount]"]').val(n.toString()),t(':input[name="pricelist[settings][bulk_markup_rounding]"]').val(o);var c=t(".pricelist_category_collection").find("tr");for(d=0;d<c.length;d++){var u=t(c.get(d)),s=u.find(':input[name$="[source]"]');e(s.val())&&r(u,n,o)}}tb_remove()})),t("#nextgen_admin_accordion .pricelist_category_collection").sortable({axis:"y",handle:"td.pricelist_sort_handle i",start:function(t,e){var i=e.item.index();e.item.data("start_position",i)},change:function(e,i){var a=i.item.data("start_position"),n=i.placeholder.index(),r=a<n?n-2:n-1;i.placeholder.prevAll("tr.item").each((function(){$this=t(this),$this.is(i.item)||($this.find(".pricelist_item_hidden_sortorder").val(r),r--)})),r=a<n?n:n+1,i.placeholder.nextAll("tr.item").each((function(){$this=t(this),$this.is(i.item)||($this.find(".pricelist_item_hidden_sortorder").val(r),r++)})),i.item.find(".pricelist_item_hidden_sortorder").val(new_position=a<n?n-1:n)}})}));