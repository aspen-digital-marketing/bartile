"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t,e){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),a=1;a<arguments.length;a++){var n=arguments[a];if(null!=n)for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(i[r]=n[r])}return i},writable:!0,configurable:!0}),function(t){Ngg_Pro_Cart={get_ajax_url:function(){return"undefined"!=typeof photocrati_ajax?photocrati_ajax.url:void 0!==parent.photocrati_ajax?parent.photocrati_ajax.url:null},Models:{},Views:{}},Ngg_Pro_Cart.Models.Image=Backbone.Model.extend({idAttribute:"pid",subtotal:function(){var t=0;return this.get("items").each((function(e){t+=e.subtotal()})),t},get_full_exif_dimensions:function(){return this.get("crop_dimensions")}}),Ngg_Pro_Cart.Models.PricelistItem=Backbone.Model.extend({idAttribute:"ID",defaults:{quantity:0,shippable_to:[]},subtotal:function(){return parseFloat(this.get("price"))*parseInt(this.get("quantity"))}}),Ngg_Pro_Cart.Models.ImageCollection=Backbone.Collection.extend({model:Ngg_Pro_Cart.Models.Image,subtotal:function(){var t=0;return this.each((function(e){t+=e.subtotal()})),t}}),Ngg_Pro_Cart.Models.PricelistItemCollection=Backbone.Collection.extend({model:Ngg_Pro_Cart.Models.PricelistItem}),Ngg_Pro_Cart.Models.Cart=Ngg_Pro_Cart.Models.ImageCollection.extend({shipping:0,total:0,sub_total:0,undiscounted_subtotal:0,discount_given:0,tax:0,settings:{shipping_address:{name:"",street_address:"",address_line:"",country:"",state:"",zip:""},studio_address:{name:"",street_address:"",address_line:"",country:"",state:"",zip:""}},coupon:"",has_shippable_items:!1,shipping_methods:[],empty_cart:function(){return this.reset(),this.storage.set("ngg_pro_cart",this.getFullCartData()),this.crop_storage.reset(),this},initialize:function(){this.ready=!1,this.storage=this.get_storage(),this.crop_storage=this.get_storage("nextgen-gallery-crop"),this.triggerReady=this.triggerReady.bind(this),this._updateCartItems=this._updateCartItems.bind(this),this._updateCartSettings=this._updateCartSettings.bind(this),this.save=this.save.bind(this),this.loadData=this.loadData.bind(this);var t;(t=100,new Promise((e,i)=>{setTimeout(e,t)})).then(this.loadData).then(this.triggerReady)},triggerReady:function(){this.ready=!0,this.trigger("ready"),this.trigger("cartReady")},getMinimalCartData:function(){var t=this.storage.get("ngg_pro_cart");return _.isObject(t)?t:_.isString(t)?JSON.parse(t):null},getFullCartData:function(){var t={image_ids:[],images:{},coupon:this.coupon};return this.each((function(e){t.image_ids.push(e.id);var i={item_ids:[],items:{}};e.get("items").each((function(t){i.item_ids.push(t.id),i.items[t.id]={quantity:t.get("quantity")}})),t.images[e.id]=i})),t},getCartData:function(){return this.ready?this.getFullCartData():this.getMinimalCartData()},requestCartData:function(){var e={action:"get_cart_items",cart:this.getCartData(),settings:this.settings};return new Promise((function(i,a){t.post(Ngg_Pro_Cart.get_ajax_url(),e,(function(t){if(_.isString(t))try{t=JSON.parse(t),i(t)}catch(t){a("Invalid JSON returned from server")}else i(t)}))}))},getImageFromCart:function(t){var e=this.get(t);return e||(e=this.findWhere({id:t})),e||(e=new Ngg_Pro_Cart.Models.Image({pid:t,items:new Ngg_Pro_Cart.Models.PricelistItemCollection})),e},_updateCartSettings:function(t){return this.settings=t.settings,this.has_shippable_items=t.has_shippable_items,this.shipping_methods=t.shipping_methods,this.shipping=parseFloat(t.shipping),this.sub_total=parseFloat(t.subtotal),this.total=parseFloat(t.total),this.tax=parseFloat(t.tax),this.undiscounted_subtotal=parseFloat(t.undiscounted_subtotal),_.isObject(t.coupon)?(this.coupon=t.coupon.code,this.discount_given=parseFloat(t.coupon.discount_given)):(this.coupon="",this.discount_given=0),this},_updateCartItems:function(t){for(var e=0;e<t.image_ids.length;e++){for(var i=parseInt(t.image_ids[e]),a=t.images[i],n=this.getImageFromCart(i),r=0;r<a.item_ids.length;r++){var s=parseInt(a.item_ids[r]);if(s>0){var o=a.items[s];o.item_id=s,o.image_id=i,itemModel=n.get("items").get(s),itemModel?itemModel.set(o):itemModel=new Ngg_Pro_Cart.Models.PricelistItem(o),n.get("items").add(itemModel,{merge:!0})}}delete a.item_ids,delete a.items,n.set(a),this.add(n,{merge:!0})}return this},loadData:function(){this.trigger("beforeLoadData");var e=this,i=t("#ngg_pro_cart_subitems_overlay");return this.requestCartData().then((function(t){return e._updateCartItems(t),e._updateCartSettings(t),t})).then((function(t){return e.save(),t})).then((function(t){e.trigger("dataLoaded",t)})).catch((function(t){console.log(t)})).finally((function(){i.removeClass("ngg_pro_cart_subitems_overlay_open")}))},get_storage:function(t){if(void 0!==t&&null!=t||(t="nextgen-gallery-cart"),"true"==Ngg_Pro_Cart_Settings.use_cookies)return Object.assign(Ngg_Store,{reset:function(){EasyCookie.keys().map(Cookies.remove),Ngg_Store.save()}});var e={namespace:t,storages:["local","cookie"],storage:"local",expiresDays:10,secure:!1},i=new window.Basil(e);return{get:function(t){return i.get(t)},set:function(t,e){return i.set(t,e)},del:function(t){return i.remove(t),!this.has(t)},has:function(t){var e=this.get(t);return void 0!==e&&null!=e},save:function(){return!0},reset:function(){i.reset()}}},getFormattedCurrency:function(t){"subtotal"==t&&(t="sub_total");var e=this[t];return _.isNumber(e)&&!_.isNaN(e)||(e=0),sprintf(Ngg_Pro_Cart_Settings.currency_format,e)},save:function(){return this.storage.set("ngg_pro_cart",this.getCartData()),this},updateQuantity:function(t,e,i){_.isObject(i)||(i={}),_.has(i,"loadData")||(i.loadData=!0);var a=!(parseInt(e.get("quantity"))>0),n=this.getImageFromCart(t),r=n.get("items"),s=r.get(e.id);s?a?r.remove(s):s.set(e.attributes):a||r.add(e.attributes),a||this.add(n,{merge:!0}),0==r.length&&this.remove(n),this.save(),i.loadData&&this.loadData()},item_count:function(){var t=0;return this.each((function(e){t+=e.get("items").length})),t}}),Ngg_Pro_Cart.get_instance=function(){return void 0===Ngg_Pro_Cart.instance&&(Ngg_Pro_Cart.instance=new Ngg_Pro_Cart.Models.Cart),Ngg_Pro_Cart.instance},Ngg_Pro_Cart.Views.TemplateView=Backbone.View.extend({render_template:function(e){var i=t("#"+this.template).html();for(var a in this.model.attributes)if("string"==typeof a)for(var n=this.model.get(a),r="{"+this.object_name+"."+a+"}";i.indexOf(r)>=0;)i=i.replace(r,n);if(void 0!==e)for(var a in e)for(r="{"+a+"}";i.indexOf(r)>=0;)i=i.replace(r,e[a]);this.$el.html(i)}}),Ngg_Pro_Cart.Views.Item_Row=Ngg_Pro_Cart.Views.TemplateView.extend({tagName:"tr",className:"ngg_pro_cart_image_item",template:"ngg_pro_cart_item_tmpl",object_name:"item",initialize:function(t){this.image_id=t.image_id,this.model.on("change:quantity",this.update_subtotal,this),this.image=Ngg_Pro_Cart.get_instance().get(this.image_id)},is_lab_item:function(){var t=!1,e=this.model.get("source");return Ngg_Pro_Cart_Settings.sources.hasOwnProperty(e)&&(t=Ngg_Pro_Cart_Settings.sources[e]),t},update_subtotal:function(){this.$el.find(".subtotal_column span").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,this.model.subtotal()))},render:function(){this.render_template({"item.id":this.model.id,"image.filename":this.image.get("filename"),"image.thumbnail_url":this.image.get("thumbnail_url"),"image.full_url":this.image.get("full_url"),"image.width":this.image.get("width"),"image.height":this.image.get("height"),"image.alttext":this.image.get("alttext")}),this.$el.find(".price_column").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,this.model.get("price"))),this.update_subtotal();var e=function(e){var i=e.model.get("crop_offset"),a=i?i.split(",").map((function(t){return t.trim()})):[];if(!(a.length<4)){e.model.get("source_data").lab_properties.aspect.ratio;var n=e.image.get_full_exif_dimensions(),r=e.$el.find(".thumbnail_column .thumbnail-container"),s=r.find("img"),o=s.width(),d=s.height(),_=r.find(".crop-preview");0==_.length&&(_=t('<div class="crop-preview" />').appendTo(r));var l=o/n.width,g=d/n.height,c=a[0]*l,h=a[1]*g,p=Math.ceil((a[2]-a[0])*l),u=Math.ceil((a[3]-a[1])*g),m=parseInt(_.css("border-left-width"),10);p-=2*m,u-=2*m,_.css({left:c,top:h}),_.width(p),_.height(u)}},i=this,a=this.$el.find(".ngg-edit-crop");if(this.is_lab_item()){var n=this.image.get("crop_dimensions"),r=this.model.get("source_data"),s=parseFloat(r.lab_properties.aspect.ratio),o=n.width/n.height,d=this.$el.find(".thumbnail_column"),l=(a=this.$el.find(".ngg-edit-crop"),this.$el.find('.thumbnail_column :input[name$="[crop_offset]"]')),g=r.lab_properties.W,c=r.lab_properties.H,h=g.toString()+"w_"+c.toString()+"h",p="image_crop_"+this.image_id.toString()+"_"+h,u=Ngg_Pro_Cart.get_instance().crop_storage.get(p);null!=u&&""!=u&&this.model.set("crop_offset",u);var m=d.find("img");m.width(n.width),m.height(n.height);var f=m.width(),v=m.height();a.data("imageSrc",this.image.get("crop_url")),a.data("printRatio",s),a.data("storeKey",p),a.data("imgRatio",o),a.data("cropZoom",f/this.image.get_full_exif_dimensions().width),a.data("cropInput",l.attr("name"));var y=this;a.on("click",(function(a){a.preventDefault();var n=t(this),r=n.data("imageSrc"),s=n.data("printRatio"),o=n.data("storeKey"),d=n.data("imgRatio"),_=n.data("cropZoom"),l=y.model.get("crop_offset"),g=l?l.split(",").map((function(t){return t.trim()})):[];g=g.map((function(t){return t*_}));var c=n.data("cropInput"),h=t("#ngg_crop_ui").clone().detach();h.width(1e3),h.height(600),h.show();var p=function(e){var i=1e3,a=600,n=t(window).width()-40,r=t(window).height()-80,s=n-Math.min(.018*n,25),o=r-Math.min(.016*r,20);i>s&&(i=s),a>o&&(a=o),e.width(i),e.height(a)},u=function(e){var a=e.width()-100,n=e.height()-100,l=a/f,h=n/v,p=Math.min(l,h),u=v*p,m=v*p;(s<1&&d>1||s>1&&d<1)&&(s=1/s),u/m-s>1?m=u/s:u=m*s;var y=0,b={viewport:{type:"square",width:u,height:m},enableZoom:!0,mouseWheelZoom:!1,showZoomer:!1,enableOrientation:!0,update:function(a){2===++y&&e.croppie("setZoom","0");var n=a.points,r=(n=n.map((function(t){return t/_}))).join(",");i.model.set("crop_offset",r),t(':input[name="'+c+'"]').val(r),Ngg_Pro_Cart.get_instance().crop_storage.set(o,r)}},C={url:r};4==g.length&&(C.points=g),e.empty();try{t("#ngg_crop_ui .crop-canvas").croppie("destroy")}catch(t){}e.croppie(b),e.croppie("bind",C)};return t(window).on("resize orientationchange onfullscreenchange onmozfullscreenchange onwebkitfullscreenchange",(function(){var e=t(".featherlight").find("#ngg_crop_ui");p(e);var i=e.find(".crop-canvas");i.length>0&&u(i)})),p(h),h.show(),t.featherlight(h,{closeOnClick:!1,otherClose:".crop-buttons .crop-button-close",afterContent:function(t){var e=this.$content.find(".crop-canvas");u(e)},afterClose:function(t){var a=Ngg_Pro_Cart.get_instance().get(i.image_id).get("items").get(i.model.id);a&&a.set(i.model.attributes),e(i)},onResize:function(t){}}),!1})),this.$el.find(".thumbnail_column .thumbnail-container img").on("load",(function(){setTimeout((function(){e(i)}),250)})),t(window).on("resize orientationchange onfullscreenchange onmozfullscreenchange onwebkitfullscreenchange",(function(){e(i)}))}else a.remove();"ngg_digital_downloads"===this.model.get("source")&&(this.$el.find(".nggpl-quantity_field_wrapper").addClass("nggpl-digital-download-source"),this.$el.find(".nggpl-quantity_field").attr("max",1)),this.$el.find(".ngg_pro_delete_item").on("click",(function(e){e.preventDefault(),i.collection.busy||(i.collection.busy=!0,i.collection.remove(i.model.id),i.model.set("quantity",0),i.$el.fadeOut(400,(function(){t(this).remove(),i.collection.busy=!1})))}));var b=this.$el.find(".quantity_column i"),C=_.throttle((function(e){var a=t(e).val();0==(a=a&&a.length>0?parseInt(a):0)&&(i.collection.remove(i.model.id),i.$el.fadeOut(400,(function(){t(this).remove()}))),i.model.set("quantity",a),Ngg_Pro_Cart.get_instance().updateQuantity(i.image_id,i.model)}),1500);return b.on("click",(function(e){var i=t(e.currentTarget),a=i.siblings("input"),n=i.hasClass("fa-minus")?-1:1,r=parseInt(a.val(),10)+n,s=parseInt(a.attr("min"),10),o=parseInt(a.attr("max"),10);r<s&&(r=s),r>o&&(r=o),a.val(r),C(a)})),this.$el.find(".nggpl-quantity_field").on("change",(function(){i.quantity_changed(this)})),this.el}}),Ngg_Pro_Cart.Views.Coupon_Row=Backbone.View.extend({el:"#ngg_pro_cart_coupon_tr",code:"",events:{"click #ngg_pro_cart_coupon_apply":"handle_apply_click","keypress #ngg_pro_cart_coupon_field":"handle_apply_key"},initialize:function(){this.model=Ngg_Pro_Cart.get_instance(),this.model.on("dataLoaded",this.handle_server_update,this),this.model.ready&&this.model.coupon&&this.model.discount_given&&this.handle_server_update()},handle_server_update_with_notice:function(){this.handle_server_update();var e=this.model,i=t("#ngg_pro_cart_coupon_errors");e.coupon&&e.discount_given?(i.hide(),t("#ngg_pro_cart_coupon_notice").fadeIn().delay(1500).fadeOut(500),t("#ngg_pro_cart_coupon_field").blur()):e.coupon&&e.discount_given||(e.coupon="",i.text("Invalid coupon"),i.fadeIn().delay(1500).fadeOut(500),t("#ngg_pro_cart_coupon_field").trigger("focus"))},handle_server_update:function(){var e=this.model,i=t("#ngg_pro_cart_coupon_undiscounted_subtotal_tr, #ngg_pro_cart_coupon_discount_amount_tr");e.coupon&&e.discount_given?(t("#ngg_pro_cart_coupon_hidden_field").val(e.coupon),t("#nggpl-undiscounced_subtotal_field").html(this.model.getFormattedCurrency("undiscounted_subtotal")),t("#nggpl-discount_amount_field").html(this.model.getFormattedCurrency("discount_given")),i.show()):e.coupon&&e.discount_given||(t("#ngg_pro_cart_coupon_hidden_field").val(""),e.coupon="",e.discount_given=0,i.hide())},handle_apply_click:function(t){t.preventDefault(),this.apply()},handle_apply_key:function(t){if(13===t.keyCode)return t.preventDefault(),this.apply(),!1},apply:function(){var e=t("#ngg_pro_cart_coupon_field");this.code=this.model.coupon=e.val();var i=this;e.val(""),this.model.loadData().then((function(){i.handle_server_update_with_notice()}))}}),Ngg_Pro_Cart.Views.Cart=Backbone.View.extend({el:"#ngg_pro_checkout",initialize:function(){var t=this;this.getRawCountryList().then((function(e){t.country_list=e,t.model=Ngg_Pro_Cart.get_instance(),t.model.on("ready",t.render,t),t.model.on("dataLoaded",t.refreshed_from_server,t),t.model.on("beforeDataLoaded",t.refreshing_from_server(),t),t.model.on("change:quantity",t.update_totals,t),t.model.ready&&(t.refreshed_from_server(),t.render())}))},events:{"keyup .nggpl-quantity_field":"sanitize_quantity","input #ngg_pro_cart_fields input":"shipping_address_changed","change #ngg_pro_cart_fields select":"shipping_address_changed","click #recalculate":"recalculate_shipping_and_taxes"},get_cart_images_el:function(){var e=this.$el.find(".ngg_pro_cart_images");return 0==e.length&&(e=t(".ngg_pro_cart_images").parent().detach(),this.$el.append(e),e=this.$el.find(".ngg_pro_cart_images")),e},fix_ie_dom:function(){if(0==this.$el.find("#ngg_pro_links_wrapper").length){var e=t("#ngg_pro_links_wrapper").detach();this.$el.prepend(e)}if(0==this.$el.find("#ngg_pro_checkout_buttons").length){var i=t("#ngg_pro_checkout_buttons").detach();this.$el.append(i)}},sanitize_quantity:function(t){return 8==t.keyCode||37==t.keyCode||39==t.keyCode||9==t.keyCode||46==t.keyCode||t.charCode>=48&&t.charCode<=57||(t.preventDefault(),!1)},get_shippable_countries:function(){var t=[];return this.model.each((function(e){e.get("items").each((function(e){_.each(e.get("shippable_to"),(function(e){t.push(e)}))}))})),t},populate_country_list:function(e){var i=t("#ngg_pro_cart_fields"),a=i.find("select.shipping_country"),n=this.model.settings.studio_address.country,r=i.find(".ngg-field-state .ngg-field-input"),s=r.find("input"),o=0,d=this.get_shippable_countries();if(void 0===e?e=this.country_data:this.country_data=e,!this.country_populated&&e){this.country_populated=!0;for(var _=0;_<e.length;_++){var l=e[_],g=l[1];if(-1!==d.indexOf(g)){var c=l[2],h=void 0!==l[3]?l[3]:"";if((v=t("<option />")).val(g),v.data("postCodeRegex",h),v.append(l[0]),a.append(v),o+=1,c.length>0){var p=t("<select />");p.append(t('<option value=""/>').append(Ngg_Pro_Cart_Settings.i18n.select_region)),p.attr("class","shipping_state"),p.data("name",s.data("name")),p.data("id",s.data("id")),p.data("countryId",g);for(var u=0;u<c.length;u++){var m=c[u],f=t("<option />");f.val(m[1]),f.append(m[0]),p.append(f)}r.append(p)}}}if(o>1){var v,y=a.find('option[value="'+n+'"]');(v=t("<option />").attr("value","")).append(Ngg_Pro_Cart_Settings.i18n.select_country),y.length>0?(y.attr("selected","selected"),a.val(n)):v.attr("selected","selected"),a.prepend(v)}this.update_country_bound_fields()}},shipping_address_changed:function(e){t(e.currentTarget).attr("name");this.update_country_bound_fields();var i=!this.shipping_fields_validate(!0,!0);(!i||i&&!recalculate)&&this.maybeDisableCheckoutButtons(i)},recalculate_shipping_and_taxes:function(){this.update_country_bound_fields(),this.shipping_fields_validate(!0,!0)},shipping_fields_validate:function(e,i){void 0===e&&(e=!1),void 0===i&&(i=!1);var a=Ngg_Pro_Cart_Settings.i18n,n=t("#ngg_pro_cart_fields"),r=n.find('input[name="settings[shipping_address][name]"]'),s=n.find('input[name="settings[shipping_address][email]"]'),o=n.find('input[name="settings[shipping_address][street_address]"]'),d=n.find('input[name="settings[shipping_address][address_line]"]'),_=n.find('input[name="settings[shipping_address][city]"]'),l=n.find(':input[name="settings[shipping_address][country]"]'),g=n.find(':input[name="settings[shipping_address][state]"]:visible'),c=n.find('input[name="settings[shipping_address][zip]"]'),h=n.find('input[name="settings[shipping_address][phone]"]'),p=function(t){return $parent=t.parentsUntil("tr","td.ngg-field-input").siblings("td.ngg-field-label"),$parent.find("label").text()},u=function(i,a){e&&($parent=i.parentsUntil("tr","td.ngg-field-input"),$errorCont=$parent.find(".ngg-field-error-container"),0==$errorCont.length?($errorCont=t('<span class="ngg-field-error-container"></span>'),$icon=t('<i class="fa fa-exclamation-triangle ngg-error-icon" aria-hidden="true"></i>'),$errorCont.append($icon),$errorCont.insertAfter(i)):$errorCont.insertAfter(i),i.is("input")&&-1==t.inArray(i.attr("type"),["checkbox","radio"])?$errorCont.addClass("ngg-field-error-container-input"):$errorCont.removeClass("ngg-field-error-container-input"),""!=a?($errorCont.attr("title",a),$errorCont.css("display","inline")):$errorCont.css("display","none"))},m=!1;if(n.find(".ngg-field-error-container").css("display","none"),r.val()&&0!==r.val().length||(u(r,sprintf(a.error_invalid,p(r),3)),m=!0),(!s.val()||s.val().length<5||!/\S+@\S+\.\S+/.test(s.val()))&&(u(s,sprintf(a.error_invalid,p(s))),m=!0),this.model.has_shippable_items){o.val()||d.val()||(u(o,sprintf(a.error_empty,p(o))),m=!0),_.val()||(u(_,sprintf(a.error_empty,p(_))),m=!0),l.val()||(u(l,sprintf(a.error_empty,p(l))),m=!0),!g.val()&&g.is("select")&&(u(g,sprintf(a.error_empty,p(g))),m=!0),h.val().length>=1&&!/^\d{3,}$/.test(h.val().replace(/[\s()+\-\.]|ext/gi,""))&&(u(h,sprintf(a.error_invalid,p(h))),m=!0);var f=l.find('option[value="'+l.val()+'"]').data("postCodeRegex");""==f||new RegExp(f,"i").test(c.val().trim())||(u(c,sprintf(a.error_invalid,p(c))),m=!0)}if(!m&&i){t("#ngg_pro_cart_subitems_overlay").addClass("ngg_pro_cart_subitems_overlay_open");var v=this.model.settings;v.shipping_address.country=l.val(),v.shipping_address.state=g.val(),v.shipping_address.zip=c.val(),v.shipping_address.name=r.val(),v.shipping_address.street_address=o.val(),v.shipping_address.address_line=d.val(),v.shipping_address.city=_.val(),v.shipping_method=null,this.model.settings=v,this.debouncedLoadData()}return m},debouncedLoadData:_.debounce((function(){this.model.loadData()}),750),getRawCountryList:function(){return new Promise((function(e,i){try{t.getJSON(Ngg_Pro_Cart_Settings.country_list_json_url,{},(function(t){e(t)}))}catch(t){i(t)}}))},maybeDisableCheckoutButtons:function(e){var i=t("#ngg_pro_checkout_buttons a, #ngg_pro_checkout_buttons button, #ngg_pro_checkout_buttons input");e?i.each((function(){t(this).prop("disabled",!1),t(this).attr("title","")})):i.each((function(){t(this).prop("disabled","disabled"),t(this).attr("title",Ngg_Pro_Cart_Settings.i18n.error_form_invalid)})),Ngg_Pro_Cart.get_instance().trigger("disable_checkout_buttons",e)},update_country_bound_fields:function(){var e=t("#ngg_pro_cart_fields"),i=e.find(".shipping_country").val(),a=e.find("input.shipping_state"),n=e.find(":input"),r=null;n.each((function(e){var n=t(this),s=n.data("name")==a.data("name"),o=n.data("countryId");o&&(o==i?(n.show(),s&&(r=n)):(s&&(n.attr("id",""),n.attr("name","")),n.hide()))})),null!=r?(r.attr("id",a.data("id")).attr("name",a.data("name")),a.hide()):a.attr("id",a.data("id")).attr("name",a.data("name")).show()},update_totals:function(e,i){void 0===e&&(e=!1),void 0===i&&(i=!0);var a=this.get_cart_images_el(),n=t("#ngg_pro_no_items"),r=t("#ngg_pro_checkout_buttons");this.model.item_count()<=0?e?(a.hide(),r.hide(),n.show()):(a.fadeOut("fast"),r.fadeOut("fast"),n.fadeIn("fast")):e?(a.show(),n.hide(),r.show()):(a.fadeIn("fast"),n.fadeOut("fast"),r.fadeIn("fast")),t("#ngg_pro_checkout").toggleClass("ngg_cart_shippable_items",this.model.has_shippable_items).toggleClass("ngg_cart_free",0==parseFloat(this.model.total)),this.$el.find("#nggpl-subtotal_field").html(this.model.getFormattedCurrency("sub_total")),this.$el.find("#nggpl-shipping_field").html(i?this.model.getFormattedCurrency("shipping"):Ngg_Pro_Cart_Settings.i18n.tbd),this.$el.find("#nggpl-total_field").html(this.model.getFormattedCurrency("total")),0===this.model.tax?this.$el.find("#tax_field_row").hide():this.$el.find("#tax_field_row").show(),this.$el.find("#nggpl-tax_field").html(this.model.getFormattedCurrency("tax"))},refreshed_from_server:function(t){var e=!this.shipping_fields_validate();t&&"string"==typeof t.error&&t.error.length>=1&&(e=!1,alert(t.error)),this.populate_country_list(this.country_list),this.shipping_fields_validate(!0),e=this.render_shipping_methods(e),this.update_totals(!0,e),this.toggle_shipping_fields()},refreshing_from_server:function(){var e=Ngg_Pro_Cart_Settings.i18n;t("#nggpl-shipping_field").text(e.calculating);var i=t("<option/>").text(e.calculating);t("#nggpl-ship_via_field select").empty().append(i),t("#nggpl-tax_field").text(e.calculating)},render_shipping_methods:function(e){var i=t("#ship_via_row select").empty(),a=this;if(e?_.each(this.model.shipping_methods,(function(e){var n=t("<option/>").val(e.name).text(e.title).attr("data-amount",e.amount);a.model.settings.hasOwnProperty("shipping_method")&&a.model.settings.shipping_method==e.name&&n.attr("selected","selected"),i.append(n)})):this.model.shipping=0,this.model.shipping_methods.length>0)t("#ship_via_row select").show(),t("#unshippable_notice").hide(),this.maybeDisableCheckoutButtons(e);else{if(this.model.settings.shipping_method=!1,this.model.save(),this.model.has_shippable_items){var n=t("#unshippable_notice");e?n.show():n.hide(),e=!1}t("#ship_via_row select").hide(),this.maybeDisableCheckoutButtons(e)}return this.model.has_shippable_items&&e?t("#ship_via_row").show():t("#ship_via_row").hide(),e},toggle_shipping_fields:function(){var e=[t("tr.ngg-shipping-field.ngg-field-street_address"),t("tr.ngg-shipping-field.ngg-field-address_line"),t("tr.ngg-shipping-field.ngg-field-city"),t("tr.ngg-shipping-field.ngg-field-country"),t("tr.ngg-shipping-field.ngg-field-state"),t("tr.ngg-shipping-field.ngg-field-zip"),t("tr.ngg-shipping-field.ngg-field-phone"),t("#shipping_field_row"),t("#ship_via_row select")];this.model.has_shippable_items?e.forEach((function(t){t.show()})):e.forEach((function(t){t.hide()}))},render:function(){var e=this;t("#ship_via_row select").on("change",(function(){e.maybeDisableCheckoutButtons(!1),t("#ngg_pro_cart_subitems_overlay").addClass("ngg_pro_cart_subitems_overlay_open");var i=e.model.settings;i.shipping_method=t(this).val(),e.model.settings=i,e.model.loadData()})),this.model.each((function(t){var i=e.get_cart_images_el(),a=t.get("items");a.each((function(e){var n=new Ngg_Pro_Cart.Views.Item_Row({model:e,collection:a,image_id:t.id});i.append(n.render())}),this)})),new Ngg_Pro_Cart.Views.Coupon_Row,this.fix_ie_dom(),t("#nggpl-shipping_field").text(Ngg_Pro_Cart_Settings.i18n.tbd),this.toggle_shipping_fields(),this.$el.css("visibility","visible")}}),Ngg_Pro_Cart.Views.Add_To_Cart=Backbone.View.extend({tagName:"div",id:"ngg_add_to_cart_container",className:"scrollable",events:function(){return{"touchstart #ngg_checkout_btn":"redirect_to_checkout","click #ngg_checkout_btn":"redirect_to_checkout","touchstart .nggpl-cart_count":"redirect_to_checkout","click .nggpl-cart_count":"redirect_to_checkout","keyup .nggpl-quantity_field":"sanitize_quantity","blur .nggpl-quantity_field":"quantity_lost_focus","focusout .nggpl-quantity_field":"quantity_lost_focus","touchstart #ngg_update_cart_btn":"update_cart","click #ngg_update_cart_btn":"update_cart","click .nggpl-quantity_field i":"update_quantity"}},update_quantity:function(e){var i=t(e.currentTarget),a=i.siblings("input"),n=i.hasClass("fa-minus")?-1:1,r=parseInt(a.val(),10)+n,s=parseInt(a.attr("min"),10),o=parseInt(a.attr("max"),10);r<s&&(r=s),r>o&&(r=o),a.val(r)},quantity_lost_focus:function(e){e.stopPropagation(),e.preventDefault(),this.limit_quantity(t(e.target)),t(window).trigger("resize"),t(".galleria-sidebar-container").trigger("focus")},getItem:function(t,e){var i=null;return _.each(this.tables,(function(a){i||a.image_id==t&&(i=a.items.get(e))}),this),i},update_cart:function(e){e.stopPropagation(),e.preventDefault();var i=this;t("#nggpl-items_for_sale td.nggpl-quantity_field input").each((function(){var e=t(this).parents("tr").data("item-id"),a=i.getItem(i.image_id,e);if(a){var n=t(this).val();n=isNaN(n)?0:parseInt(n),a.set("quantity",n)}else a=new Ngg_Pro_Cart.Models.PricelistItem({ID:e,quantity:0});Ngg_Pro_Cart.get_instance().updateQuantity(i.image_id,a,{loadData:!1})})),this.model.save(),this.model.loadData()},limit_quantity:function(t){var e=parseInt(t.attr("min"),10),i=parseInt(t.attr("max"),10),a=parseInt(t.val(),10);a<e&&(a=e),a>i&&(a=i),t.val(a)},sanitize_quantity:function(e){return e.stopPropagation(),8===e.keyCode||37===e.keyCode||39===e.keyCode||9===e.keyCode||46===e.keyCode||e.charCode>=48&&e.charCode<=57?(this.limit_quantity(t(e.target)),!0):(e.preventDefault(),!1)},initialize:function(t){this.tables={},this.image_id=t.image_id,this.container=t.container,this.datacache=t.datacache,this.model=Ngg_Pro_Cart.get_instance(),this.listenTo(this.model,"ready",this.render),this.listenTo(this.model,"dataLoaded",this.update_and_animate_cart_summary),this.model.ready&&this.render()},update_and_animate_cart_summary:function(){this.update_cart_summary(!0)},redirect_to_checkout:function(t){t.stopPropagation(),t.preventDefault();var e=encodeURIComponent(parent.location.toString()),i=Ngg_Pro_Cart_Settings.checkout_url;i.indexOf("?")>0?i+="&referrer="+e:i+="?referrer="+e,parent.location=i},update_cart_summary:function(e){var i=this.$el.find(".nggpl-cart_summary");i.find(".nggpl-cart_count").text(ngg_cart_i18n.item_count.replace("%d",this.model.item_count())),i.find(".nggpl-cart_total").html(this.model.getFormattedCurrency("sub_total")),this.set_add_or_update_cart_text(),e&&(t("#nggpl-cart_updated_wrapper").addClass("nggpl-cart_updated_wrapper_visible"),setTimeout((function(){t("#nggpl-cart_updated_wrapper").removeClass("nggpl-cart_updated_wrapper_visible")}),1500))},set_add_or_update_cart_text:function(){var e=t("#ngg_update_cart_btn");e.length>0&&(this.model.item_count()>0?e.val(e.data("update-string")):e.val(e.data("add-string")))},render:function(){var e=this.image_id;this.container.empty(),this.$el.empty(),this.$el.attr("data-image-id",e),this.$el.append(ngg_add_to_cart_templates.add_to_cart_wrapper);var i=this;this.update_cart_summary(!1),this.tables={},this.$el.find(".nggpl-pricelist_category_wrapper").find(".nggpl-category_contents").each((function(){var a=new Ngg_Pro_Cart.Views.Add_To_Cart.Items_Table({image_id:e,datacache:i.datacache});t(this).empty().append(a.render()),i.tables[t(this).attr("id")]=a}));var a=Ngg_Pro_Cart.get_instance(),n=_.has(a.getCartData().images,e)?a.getCartData().images[e].items:[],r=_.has(this.datacache.image_items,"items")?this.datacache.image_items.items:[];_.each(n,(function(t,e){_.each(r,(function(i,a){i.ID==e&&(r[a].quantity=t.quantity)}))})),_.each(r,(function(t,e){_.has(n,t.ID)||(r[e].quantity=0)})),_.each(_.filter(r,(function(t){return""!==t.title})),(function(t){i.tables[t.category].items.add(t)}),i),this.container.append(this.el),_.each(i.tables,(function(e){var a=e.$el.parent().attr("id"),n=t("#"+a+"_header").parent();if(0===i.tables[a].items.length)n.hide();else{var r=t("<h3>"+n.html()+"</h3>");r.attr("data-ngg-category",a),t("#nggpl-category-headers").append(r),r.on("click",(function(){t("#npl_sidebar").animate({scrollTop:n.position().top})}))}}),i),r.length>0?(i.$el.find("#nggpl-not_for_sale").css("display","none"),i.$el.find("#nggpl-items_for_sale").css("display","inline-block")):(i.$el.find("#nggpl-items_for_sale").css("display","none"),i.$el.find("#nggpl-not_for_sale").css("display","block")),t.nplModal("get_setting","sidebar_button_color")&&i.$el.find("#ngg_checkout_btn, #ngg_update_cart_btn").css({color:t.nplModal("get_setting","sidebar_button_color")}),t.nplModal("get_setting","sidebar_button_background")&&i.$el.find("#ngg_checkout_btn, #ngg_update_cart_btn").css({"background-color":t.nplModal("get_setting","sidebar_button_background")}),this.set_add_or_update_cart_text(),t("#npl_content").trigger("npl_sidebar_rendered"),t("#nggpl-cart_sidebar_checkout_buttons, #nggpl-cart-static-header").css({background:t.nplModal("get_setting","sidebar_background_color")}),void 0!==i.datacache.digital_download_settings&&(t(".nggpl-pricelist_category_wrapper #ngg_category_digital_downloads_header").html(i.datacache.digital_download_settings.header),_.each(t("#nggpl-category-headers h3"),(function(e){"ngg_category_digital_downloads"===t(e).data("ngg-category")&&t(e).find("span").html(i.datacache.digital_download_settings.header)}))),a.trigger("rendered"),t("#npl_wrapper").removeClass("npl-sidebar-overlay-open")}}),Ngg_Pro_Cart.Views.Add_To_Cart.Items_Table=Backbone.View.extend({tagName:"table",class:"items_table",initialize:function(t){this.image_id=t.image_id,this.datacache=t.datacache,this.items=new Ngg_Pro_Cart.Models.PricelistItemCollection,this.items.on("add",this.render_row,this)},render:function(){return this.$el.hide(),this.$el.html(ngg_add_to_cart_templates.add_to_cart_header),this.$el.attr("data-image-id",this.image_id),this.el},render_row:function(t){var e=new Ngg_Pro_Cart.Views.Add_To_Cart.Item_Row({model:t,image_id:this.image_id,datacache:this.datacache});this.$el.find("tbody").append(e.render()),this.$el.show()}}),Ngg_Pro_Cart.Views.Add_To_Cart.Item_Row=Backbone.View.extend({tagName:"tr",events:{"updated_quantity input":"update_quantity","click .nggpl-add-download-button":"update_download_items"},initialize:function(t){this.image_id=t.image_id,this.datacache=t.datacache,this.model.on("change:quantity",this.update_subtotal,this),this.skip_checkout="1"===this.datacache.digital_download_settings.skip_checkout},update_download_items:function(){var t=this.model.get("price"),e=this.$el.find(".nggpl-add-download-button");if(0===t&&this.skip_checkout){var i=Ngg_Pro_Cart.get_ajax_url();i+="&action=get_image_file",i+="&image_id="+this.image_id,i+="&item_id="+this.model.get("ID");var a=document.createElement("a");a.style.display="none",a.href=i,document.body.appendChild(a),a.click(),document.body.removeChild(a),delete a}else 0===this.model.get("quantity")?(e.html(e.data("remove-text")),this.model.set("quantity",1)):(e.html(e.data("add-text")),this.model.set("quantity",0)),Ngg_Pro_Cart.get_instance().updateQuantity(this.image_id,this.model)},render:function(){var t=this.model.get("price");if("ngg_digital_downloads"===this.model.get("source")){this.$el.html(ngg_add_to_cart_templates.add_to_cart_download_item);var e=this.$el.find(".nggpl-add-download-button");0===t&&this.skip_checkout?e.html(e.data("free-text")):this.model.get("quantity")>0&&e.html(e.data("remove-text"))}else this.$el.html(ngg_add_to_cart_templates.add_to_cart_normal_item);this.$el.attr("data-item-id",this.model.id),this.$el.find(".nggpl-quantity_field input").val(this.model.get("quantity")),this.$el.find(".nggpl-description_field").text(this.model.get("title"));var i=this.$el.find(".nggpl-price_field");return 0===t&&this.skip_checkout?i.html(i.data("free-label")):i.html(sprintf(Ngg_Pro_Cart_Settings.currency_format,t)),this.$el.find(".nggpl-total_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,this.model.subtotal())),this.el},update_quantity:function(e,i){var a=t(e.target).val();a=isNaN(a)?0:parseInt(a),this.model.set("quantity",a),Ngg_Pro_Cart.get_instance().updateQuantity(this.image_id,this.model,i)},update_subtotal:function(){this.$el.find(".nggpl-total_field").html(sprintf(Ngg_Pro_Cart_Settings.currency_format,this.model.subtotal()))}}),void 0!==window.Ngg_Pro_Cart&&window.Ngg_Pro_Cart.get_instance().on("dataLoaded",(function(){t("i.nextgen-menu-cart-icon").each((function(e){var i=t(this),a=!1,n=i.parents("li"),r=n.find(".nextgen-menu-cart-placeholder");((i.hasClass("nextgen-menu-cart-icon-icon_and_total_with_items")||i.hasClass("nextgen-menu-cart-icon-icon_with_items"))&&Ngg_Pro_Cart.get_instance().subtotal()>0||i.hasClass("nextgen-menu-cart-icon-icon_and_total")||i.hasClass("nextgen-menu-cart-icon-icon"))&&(a=!0),r.length>0&&r.html(" ("+Ngg_Pro_Cart.get_instance().getFormattedCurrency("sub_total")+")"),a?(i.show(),n.show()):n.hide()}))}))}(jQuery);