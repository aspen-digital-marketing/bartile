!function(e){var t;e("span.tooltip, label.tooltip").tooltip(),e("#ecommerce_currency").on("focus",(function(){t=e("#ecommerce_currency").val()})).on("change",(function(){e(this).unbind("focus");var i=confirm(NGG_Pro_EComm_Settings.i18n.currency_changed);return i||e(this).val(t).bind("focus"),i})),e('select[name="ecommerce[home_country]"]').on("change",(function(){var t=e(this),i=NGG_Pro_EComm_Settings.iso_4217_countries,n=t.val(),r=null;for(var a in i)if(i.hasOwnProperty(a)){var o=i[a];if(o.code===n){r=o;break}}if(r){var l=e('select[name="ecommerce[currency]"]'),d=r.currency_code;l.find('option[value="'+d+'"]').length>0&&l.val(d)}}));var i=function(){var t=e(this),i=t.val(),n=t.parent().children();n.hide(),t.show(),n.filter(".show_on_"+i).show()};e('select[name="ecommerce[intl_shipping]"]').on("change",i).trigger("change"),e('select[name="ecommerce[domestic_shipping]"]').on("change",i).trigger("change"),e(".ecommerce_enable_email_receipt").on("change",(function(t){1===parseInt(e(t.target).val())?e("#tr_ecommerce_email_receipt_subject.hidden, #tr_ecommerce_email_receipt_body.hidden").each((function(){e(this).fadeIn("fast",(function(){e(this).removeClass("hidden")}))})):e("#tr_ecommerce_email_receipt_subject, #tr_ecommerce_email_receipt_body").each((function(){e(this).fadeOut("fast",(function(){e(this).addClass("hidden")}))}))})),e((function(){var t={settings:{},field_selectors:{},field_rules:{},i18n:{},initialize:function(t,i,n){this.settings=t,this.field_selectors=this.settings.field_selectors,this.field_rules=this.settings.field_rules,this.i18n=i;var r=this;e.getJSON(this.settings.country_list_json_url,{},(function(e){r.populate_country_list(e),n(r)}))},get_field:function(t,i){if(null==i&&(i=e(document)),t in this.field_selectors){var n=this.field_selectors[t];return i.find(n)}return e()},get_child_field:function(e,t){return this.get_field(t,e)},get_all_fields:function(){var t=e(),i=this.get_field("root");for(var n in this.field_selectors)if("root"!==n&&this.field_selectors.hasOwnProperty(n)){var r=this.get_child_field(i,n);t=t.add(r)}return t},populate_country_list:function(t){var i=this.get_field("root"),n=this.get_child_field(i,"country"),r=this.get_child_field(i,"state").filter("input"),a=e(r.get(0)).closest("td"),o=0;r.attr("name")&&!r.data("name")&&(r.data("name",r.attr("name")),r.attr("name","")),r.attr("id")&&!r.data("id")&&r.data("id",r.attr("id"));for(var l=0;l<t.length;l++){var d=t[l],s=d[1],c=d[2],_=void 0!==d[3]?d[3]:"",p=e("<option />");if(p.val(s),p.data("postCodeRegex",_),p.append(d[0]),n.append(p),o+=1,c.length>0){var g=e("<select />");g.append(e("<option />").attr("value","").append(this.i18n.select_region)),g.attr("class",r.attr("class")),g.addClass("state-generated-dropdown"),g.data("name",r.data("name")),g.data("id",r.data("id")),g.data("countryId",s);for(var h=0;h<c.length;h++){var m=c[h],f=e("<option />");f.val(m[1]),f.append(m[0]),g.append(f)}a.append(g),s===this.settings.selected_country&&g.val(this.settings.selected_state)}}o>1&&n.prepend(e("<option />").attr("value","").attr("selected","selected").append(this.i18n.select_country)),this.update_country_bound_fields()},getFieldName:function(e){return $parent=e.closest("td").siblings(),$parent.find("label").text().trim()},validationError:function(t,i,n){"never"===t&&(n=null);var r=i.closest("td"),a=r.find(".ngg-field-error-container");0!==a.length&&a.is(":visible")||"only_clear"!==t||(n=null),0===a.length&&((a=e('<span class="ngg-field-error-container"></span>')).append(e('<i class="fa fa-exclamation-triangle ngg-error-icon" aria-hidden="true"></i>')),r.append(a));var o=!1;if(i.is("input")&&-1===e.inArray(i.attr("type"),["checkbox","radio"])?(o=!0,a.addClass("ngg-field-error-container-input")):a.removeClass("ngg-field-error-container-input"),n){a.attr("title",n),a.css("display","inline");var l=i.data("originalWidth");l||(l=i.width(),i.data("originalWidth",l)),l&&!o&&i.width(l-a.width()-10),i.css({border:"1px solid red"})}else a.css("display","none"),i.width(""),i.removeAttr("style")},general_fields_validate:function(t){void 0!==t&&t||(t="never");var i=this.get_field("root"),n=this.get_child_field(i,"address_line"),r=this.get_child_field(i,"city"),a=this.get_child_field(i,"country"),o=this.get_child_field(i,"name"),l=this.get_child_field(i,"street_address"),d=this.get_child_field(i,"zip"),s=this.get_child_field(i,"email"),c=i.find(".state-generated-dropdown:visible");0===c.length&&(c=this.get_child_field(i,"state"));var _=this.i18n,p=!1;0===o.val().length?(this.validationError(t,o,sprintf(_.error_empty,this.getFieldName(o))),p=!0):this.validationError(t,o,null),0===s.val().length?(this.validationError(t,s,sprintf(_.error_empty,this.getFieldName(s))),p=!0):this.validationError(t,s,null),0===l.val().length&&0===n.val().length?(this.validationError(t,l,sprintf(_.error_empty,this.getFieldName(l))),p=!0):this.validationError(t,l,null),0===r.val().length?(this.validationError(t,r,sprintf(_.error_empty,this.getFieldName(r))),p=!0):this.validationError(t,r,null),a.val()&&0!==a.val().length?(this.validationError(t,a,null),e("#tr_ecommerce_home_state").show(),e("#tr_ecommerce_home_zip").show()):(this.validationError(t,a,sprintf(_.error_empty,this.getFieldName(a))),p=!0,e("#tr_ecommerce_home_state").hide(),e("#tr_ecommerce_home_zip").hide()),c.length>0&&c.is("select")&&""===c.val()?(this.validationError(t,c,sprintf(_.error_empty,this.getFieldName(c))),p=!0):this.validationError(t,c,null);var g=a.find('option[value="'+a.val()+'"]').data("postCodeRegex");return""===g||new RegExp(g,"i").test(d.val())?this.validationError(t,d,null):(this.validationError(t,d,sprintf(_.error_invalid,this.getFieldName(d))),p=!0),p},gateway_fields_validate:function(t){void 0!==t&&t||(t="never");var i=this.get_field("root"),n=this.i18n,r=!1,a="1"===e('input[name="ecommerce[paypal_std_enable]"]:checked').val(),o=this.get_child_field(i,"paypal_std_email");a&&""===o.val()?(this.validationError(t,o,sprintf(n.error_empty,this.getFieldName(o))),r=!0):this.validationError(t,o,null);var l="1"===e('input[name="ecommerce[stripe_enable]"]:checked').val(),d=this.get_child_field(i,"stripe_key_pub");l&&""===d.val()?(this.validationError(t,d,sprintf(n.error_empty,this.getFieldName(d))),r=!0):this.validationError(t,d,null);var s=this.get_child_field(i,"stripe_key_priv");l&&""===s.val()?(this.validationError(t,s,sprintf(n.error_empty,this.getFieldName(s))),r=!0):this.validationError(t,s,null);var c="1"===e('input[name="ecommerce[paypal_enable]"]:checked').val(),_=this.get_child_field(i,"paypal_email");c&&""===_.val()?(this.validationError(t,_,sprintf(n.error_empty,this.getFieldName(_))),r=!0):this.validationError(t,_,null);var p=this.get_child_field(i,"paypal_user");c&&""===p.val()?(this.validationError(t,p,sprintf(n.error_empty,this.getFieldName(p))),r=!0):this.validationError(t,p,null);var g=this.get_child_field(i,"paypal_pass");c&&""===g.val()?(this.validationError(t,g,sprintf(n.error_empty,this.getFieldName(g))),r=!0):this.validationError(t,g,null);var h=this.get_child_field(i,"paypal_sig");return c&&""===h.val()?(this.validationError(t,h,sprintf(n.error_empty,this.getFieldName(h))),r=!0):this.validationError(t,h,null),r},validate_all_fields:function(i){var n=e(".ngg-error-message-root"),r=e("button.ngg_save_settings_button"),a=t.general_fields_validate(i),o=t.gateway_fields_validate(i);if(!a&&!o)return r.prop("disabled",!1),e(".ngg-error-message-root").hide(),e(".ngg_page_content_menu .ngg-error-icon").hide(),n.hide(),!1;r.prop("disabled","disabled");var l=e('.ngg_page_content_menu [data-id="ngg-ecommerce-options"]');a?(l.css({display:"flex","align-items":"center","padding-right":"0"}),l.length>0&&(0===(d=l.find(".ngg-error-icon")).length&&(l.css("position","relative"),(d=e('<i class="fa fa-exclamation-triangle ngg-error-icon" aria-hidden="true" style="color: #ca090f; padding-right: 4px; padding-left: 4px; font-size: 12px !important;"></i>')).attr("title",NGG_Pro_EComm_Settings.i18n.form_invalid),d.appendTo(l)),d.show())):l.css({display:"block","padding-right":"20px"});var d,s=e('.ngg_page_content_menu [data-id="ngg-payment-gateways"]');o?(s.css({display:"flex","align-items":"center","padding-right":"0"}),s.length>0&&(0===(d=s.find(".ngg-error-icon")).length&&((d=e('<i class="fa fa-exclamation-triangle ngg-error-icon" aria-hidden="true" style="color: #ca090f; padding-right: 4px; font-size: 125% !important;"></i>')).attr("title",NGG_Pro_EComm_Settings.i18n.form_invalid),d.appendTo(s)),d.show())):s.css({display:"block","padding-right":"20px"});return!0},update_country_bound_fields:function(){var t=this.get_field("root"),i=this.get_child_field(t,"country"),n=i.find("option[selected]").val();""===n&&(n=i.val());var r=this.get_child_field(t,"state").filter("input"),a=t.find(":input").not(r),o=null;a.each((function(){var t=e(this),i=t.data("name")===r.data("name"),a=t.data("countryId");a&&(a===n?(t.show(),i&&(o=t)):(i&&(t.attr("id",""),t.attr("name","")),t.hide()))})),null!=o?(o.attr("id",r.data("id")).attr("name",r.data("name")),r.attr("name","").hide()):r.attr("name",r.data("name")).show()}};t.initialize(NGG_Pro_EComm_Settings,NGG_Pro_EComm_Settings.i18n,(function(t){var i=t.get_field("root"),n=t.get_child_field(i,"country");n.val(NGG_Pro_EComm_Settings.selected_country),t.update_country_bound_fields(),t.validate_all_fields(!0),n.on("change",(function(){t.update_country_bound_fields()})),e("select.ecommerce_home_state.state-generated-dropdown").on("change",(function(){t.validate_all_fields(!0)})),t.get_all_fields().on("input change",(function(){t.validate_all_fields(!0)})),e('input[name="ecommerce[paypal_std_enable]"], input[name="ecommerce[paypal_enable]"], input[name="ecommerce[stripe_enable]"]').on("change",(function(e){t.validate_all_fields(!0)})),e("#ngg_page_content form").on("submit",(function(e){if(t.validate_all_fields(!0))return e.preventDefault(),!1}))}))})),window.nggCardElement=null,e("#delete-stripe-card").on("click",(function(t){var i=e(this);t.preventDefault(),e.post(photocrati_ajax.url,{action:"delete_credit_card_info",nonce:atob(i.attr("data-nonce"))},(function(t){"object"!=typeof t&&(t=JSON.parse(t)),i.attr("data-nonce",t.next_nonce),t.success?(e(".stripe_connect_declined").remove(),e("#delete-stripe-card").hide(),e(".stripe_connect_active").text(print_lab_i18n.card_removed),nggShowStripeForm()):alert(print_lab_i18n.remove_card_err)}))})),window.nggAppendStripeErr=function(){e("div[data-id='ngg-ecommerce-printlab']").append(e("<span/>").addClass("stripe_connect_declined").text(print_lab_i18n.not_connected))},window.nggShowDeleteCard=function(){e("#delete-stripe-card").show()},window.nggInitStripeElements=function(t,i){var n=Stripe(t?"pk_test_MTNtYD9qsldURz7OzkYOOxKa":"pk_live_yRBibCwDB4gh97T758I4VRYy"),r=n.elements().create("card",{style:{base:{color:"#32325d",lineHeight:"24px",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},hidePostalCode:!0});window.nggCardElement=r,r.mount("#card-element"),r.addEventListener("change",(function(e){var t=document.getElementById("card-errors");e.error?t.textContent=e.error.message:t.textContent=""}));var a=document.getElementById("ngg-stripe-form");0==e(".stripe-connect-disabled").length&&a.addEventListener("click",(function(a){a.preventDefault(),n.createPaymentMethod("card",r).then((function(t){return t.error?Promise.reject(t.error):fetch(nggpro_stripe_data.server_url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.extend(nggpro_stripe_data,{payment_method_id:t.paymentMethod.id}))})})).then((function(e){return e.json()})).then((function(e){return"succeeded"==e.status?{setupIntent:e}:n.handleCardSetup(e.client_secret,r)})).then((function(e){return e.error?Promise.reject(e.error):e.setupIntent})).then((function(n){var r={testing:t,payment_method:n.payment_method,action:"update_credit_card_info",nonce:atob(i)};e.post(photocrati_ajax.url,r,(function(t){"object"!=typeof t&&(t=JSON.parse(t)),e(".stripe_connect_declined").remove(),e(".stripe_connect_active").remove(),nggpro_stripe_data.update_nonce=t.next_nonce,t.success?(e("div[data-id='ngg-ecommerce-printlab']").append(e("<span/>").addClass("stripe_connect_active").text(print_lab_i18n.connected)),e("#delete-stripe-card").show(),e("#ngg-stripe-form").hide(),e(".stripe_connect_declined").remove(),window.nggCardElement.unmount()):(e("div[data-id='ngg-ecommerce-printlab']").append(e("<span/>").addClass("stripe_connect_declined").text(print_lab_i18n.not_connected)),e(".stripe_connect_active").remove())}))})).catch(nggAppendStripeErr)}))},window.nggShowStripeForm=function(){e("#ngg-stripe-form").show(),nggInitStripeElements(nggpro_stripe_data.testing,nggpro_stripe_data.update_nonce)},e((function(){nggpro_stripe_data.isSetupDone?nggShowDeleteCard():nggShowStripeForm()}))}(jQuery);